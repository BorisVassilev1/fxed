name: CI

on:
  push:
  pull_request:

jobs:
  build:
    name: Build (${{ matrix.os }} / ${{ matrix.build_type }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
        build_type: [Debug, Release]

    env:
      # Keep a default Vulkan SDK version to try to download when a packaged SDK isn't available.
      VULKAN_SDK_VERSION: 1.4.341.1

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Vulkan SDK
        if: matrix.os == 'ubuntu-latest'
        uses: jakoch/install-vulkan-sdk-action@v1
        with:
          vulkan_version: ${{ env.VULKAN_SDK_VERSION }}
          optional_components: com.lunarg.vulkan.glm
          install_runtime: true
          cache: true
          stripdown: true


      - name: Setup common tools (cmake, ninja)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake ninja-build pkg-config git
        shell: bash

      - name: Setup common tools (Windows - MSYS2/Mingw)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          choco feature enable -n allowGlobalConfirmation
          # Install MSYS2 which provides mingw-w64 toolchains and pacman package manager
          choco install -y msys2
          # Update MSYS2 core packages and then install the mingw-w64 toolchain, clang, ninja and cmake
          # Use the msys2 bash to run pacman updates and installs
          if (Test-Path 'C:\tools\msys64\usr\bin\bash.exe') {
            $msysbash = 'C:\tools\msys64\usr\bin\bash.exe'
          } elseif (Test-Path 'C:\msys64\usr\bin\bash.exe') {
            $msysbash = 'C:\msys64\usr\bin\bash.exe'
          } else {
            Write-Host 'MSYS2 bash not found at expected locations; pacman steps will be attempted with C:\tools\msys64 path.'
            $msysbash = 'C:\tools\msys64\usr\bin\bash.exe'
          }
          & $msysbash -lc "pacman -Syu --noconfirm"
          & $msysbash -lc "pacman -S --noconfirm mingw-w64-x86_64-toolchain mingw-w64-x86_64-clang mingw-w64-x86_64-ninja mingw-w64-x86_64-cmake mingw-w64-x86_64-pkg-config mingw-w64-x86_64-fontconfig"

      - name: Install runtime/development deps (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          set -e
          # Common X / font deps used by the project
          sudo apt-get install -y libfontconfig1-dev libx11-dev libxrandr-dev libxinerama-dev libxcursor-dev libxi-dev
          # Wayland development packages for GLFW
          sudo apt-get install -y libwayland-dev libxkbcommon-dev wayland-protocols
        shell: bash

      - name: Install Vulkan SDK (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          # Try installing Vulkan SDK via Chocolatey (may install the latest if exact version isn't available)
          choco install -y vulkan-sdk --version=$env:VULKAN_SDK_VERSION || choco install -y vulkan-sdk || Write-Host "vulkan-sdk install via choco failed; runner may already have SDK or rely on system drivers"
          # Common default location for LunarG on Windows; if present, expose it to the job environment
          $default = "C:\VulkanSDK\$($env:VULKAN_SDK_VERSION)"
          if (Test-Path $default) {
            # Check for dxcompiler import lib which is what CMake expects to link on Windows
            $dxpath = Join-Path $default 'Lib\dxcompiler.lib'
            if (Test-Path $dxpath) {
              echo "VULKAN_SDK=$default" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
              Write-Host "dxcompiler.lib found at $dxpath; VULKAN_SDK set to $default"
            } else {
              # Still export VULKAN_SDK (useful for loaders/headers), but warn about missing import lib
              echo "VULKAN_SDK=$default" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
              Write-Host "VULKAN_SDK set to $default but dxcompiler.lib was NOT found at $dxpath. Linking with mingw toolchains may fail; consider using clang-cl/MSVC toolchain or provide a MinGW-compatible import lib or dynamic-load dxcompiler.dll."
            }
          } else {
            Write-Host "VULKAN_SDK default path not found; if build requires dxcompiler.lib ensure VULKAN_SDK is available on the runner."
          }

      - name: Configure (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          chmod +x configure.sh
          # Modify configure.sh to use the build_type from matrix
          sed "s/-DCMAKE_BUILD_TYPE=Release/-DCMAKE_BUILD_TYPE=${{ matrix.build_type }}/g" configure.sh > configure_ci.sh
          chmod +x configure_ci.sh
          ./configure_ci.sh
        shell: bash

      - name: Configure (Windows - MSYS2 Mingw + Ninja)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          Write-Host 'Attempting to add MSYS2 mingw64 to PATH so gcc/g++/ninja are available'
          if (Test-Path 'C:\tools\msys64\mingw64\bin') {
            echo 'C:\tools\msys64\mingw64\bin' | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          } elseif (Test-Path 'C:\msys64\mingw64\bin') {
            echo 'C:\msys64\mingw64\bin' | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          } else {
            Write-Host 'MSYS2 mingw64 bin not found in common locations; ensure MSYS2 pacman installed the mingw packages.'
          }
          # Modify configure.bat to use the build_type from matrix and standardize build directory to 'build'
          (Get-Content configure.bat) `
            -replace '-DCMAKE_BUILD_TYPE=Release', "-DCMAKE_BUILD_TYPE=${{ matrix.build_type }}" `
            -replace 'build-win', 'build' | Set-Content configure_ci.bat
          # Run the configure script
          cmd /c configure_ci.bat

      - name: Build
        run: |
          cmake --build build --config ${{ matrix.build_type }} --parallel
        shell: bash

      - name: Run tests (if tests configured)
        run: |
          # If CTest tests are available, run them. Don't fail the whole job on test failures here unless desired.
          if [ -d build ]; then
            cmake --build build --target test --config ${{ matrix.build_type }} || true
          fi
        shell: bash
        if: matrix.os == 'ubuntu-latest'

      - name: Collect binary path candidates
        id: collect
        run: |
          # CMakeLists sets RUNTIME_OUTPUT_DIRECTORY ../ so executables may be in repository root or build dirs.
          candidates=()
          if [ -f fxed ]; then candidates+=("fxed"); fi
          if [ -f fxed.exe ]; then candidates+=("fxed.exe"); fi
          if [ -f build/fxed ]; then candidates+=("build/fxed"); fi
          if [ -f build/fxed.exe ]; then candidates+=("build/fxed.exe"); fi
          if [ -f build/${{ matrix.build_type }}/fxed.exe ]; then candidates+=("build/${{ matrix.build_type }}/fxed.exe"); fi
          if [ -f build/${{ matrix.build_type }}/fxed ]; then candidates+=("build/${{ matrix.build_type }}/fxed"); fi
          # Print found candidates (for logs) and join with newline for upload step
          for f in "${candidates[@]}"; do echo "FOUND_BINARY:$f"; done
          printf "%s\n" "${candidates[@]}" > artifact-list.txt || echo "No binaries found"
        shell: bash

      - name: Upload artifact (built executable)
        uses: actions/upload-artifact@v4
        with:
          name: fxed-binaries-${{ matrix.os }}-${{ matrix.build_type }}
          # Provide multiple candidate paths (artifact-list.txt plus common binary locations).
          path: |
            artifact-list.txt
            fxed
            fxed.exe
            build/fxed
            build/fxed.exe
            build/${{ matrix.build_type }}/fxed
            build/${{ matrix.build_type }}/fxed.exe
        # Note: upload-artifact will only include files that actually exist.

      - name: Print environment (debug)
        if: always()
        run: |
          echo "OS=${{ matrix.os }}"
          echo "BUILD_TYPE=${{ matrix.build_type }}"
          echo "VULKAN_SDK=${VULKAN_SDK}"
          uname -a || systeminfo
        shell: bash
