name: CI

on:
  push:
  pull_request:

jobs:
  build:
    name: Build (${{ matrix.os }} / ${{ matrix.build_type }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
        build_type: [Debug, Release]

    env:
      # Keep a default Vulkan SDK version to try to download when a packaged SDK isn't available.
      VULKAN_SDK_VERSION: 1.4.341.1

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Vulkan SDK
        #if: matrix.os == 'ubuntu-latest'
        uses: jakoch/install-vulkan-sdk-action@v1
        with:
          vulkan_version: ${{ env.VULKAN_SDK_VERSION }}
          optional_components: com.lunarg.vulkan.glm
          install_runtime: true
          cache: true
          stripdown: true


      - name: Setup common tools (cmake, ninja)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake ninja-build pkg-config git
        shell: bash

      - name: Setup common tools (Windows - MSYS2/Mingw)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          choco feature enable -n allowGlobalConfirmation
          # Install MSYS2 which provides mingw-w64 toolchains and pacman package manager
          choco install -y msys2
          # Update MSYS2 core packages and then install the mingw-w64 toolchain, clang, ninja and cmake
          # Use the msys2 bash to run pacman updates and installs
          if (Test-Path 'C:\tools\msys64\usr\bin\bash.exe') {
            $msysbash = 'C:\tools\msys64\usr\bin\bash.exe'
          } elseif (Test-Path 'C:\msys64\usr\bin\bash.exe') {
            $msysbash = 'C:\msys64\usr\bin\bash.exe'
          } else {
            Write-Host 'MSYS2 bash not found at expected locations; pacman steps will be attempted with C:\tools\msys64 path.'
            $msysbash = 'C:\tools\msys64\usr\bin\bash.exe'
          }
          & $msysbash -lc "pacman -Syu --noconfirm"
          & $msysbash -lc "pacman -S --noconfirm mingw-w64-x86_64-toolchain mingw-w64-x86_64-clang mingw-w64-x86_64-ninja mingw-w64-x86_64-cmake mingw-w64-x86_64-pkg-config mingw-w64-x86_64-fontconfig mingw-w64-x86_64-freetype"

      - name: Install runtime/development deps (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          set -e
          # Common X / font deps used by the project
          sudo apt-get install -y libfontconfig1-dev libx11-dev libxrandr-dev libxinerama-dev libxcursor-dev libxi-dev
          # Wayland development packages for GLFW
          sudo apt-get install -y libwayland-dev libxkbcommon-dev wayland-protocols
        shell: bash

      - name: Configure (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          chmod +x configure.sh
          # Modify configure.sh to use the build_type from matrix
          sed "s/-DCMAKE_BUILD_TYPE=Release/-DCMAKE_BUILD_TYPE=${{ matrix.build_type }}/g" configure.sh > configure_ci.sh
          chmod +x configure_ci.sh
          ./configure_ci.sh
        shell: bash

      - name: Configure (Windows - MSYS2 Mingw + Ninja)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          Write-Host 'Attempting to add MSYS2 mingw64 to PATH so gcc/g++/ninja are available'
          $mingwPath = ''
          if (Test-Path 'C:\tools\msys64\mingw64\bin') {
            echo 'C:\tools\msys64\mingw64\bin' | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
            $mingwPath = 'C:\tools\msys64\mingw64'
          } elseif (Test-Path 'C:\msys64\mingw64\bin') {
            echo 'C:\msys64\mingw64\bin' | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
            $mingwPath = 'C:\msys64\mingw64'
          } else {
            Write-Host 'MSYS2 mingw64 bin not found in common locations; ensure MSYS2 pacman installed the mingw packages.'
            $mingwPath = 'C:\tools\msys64\mingw64'
          }
          # Set PKG_CONFIG_PATH to help CMake find FreeType and other libraries
          $pkgConfigPath = "$mingwPath\lib\pkgconfig"
          echo "PKG_CONFIG_PATH=$pkgConfigPath" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          Write-Host "PKG_CONFIG_PATH set to $pkgConfigPath"
          # Also set CMAKE_PREFIX_PATH to help CMake find libraries
          echo "CMAKE_PREFIX_PATH=$mingwPath" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          Write-Host "CMAKE_PREFIX_PATH set to $mingwPath"

      - name: Debug FreeType installation (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          Write-Host "=== Checking FreeType installation ==="
          # Check for FreeType in common MSYS2 locations
          $locations = @(
            "C:\tools\msys64\mingw64",
            "C:\msys64\mingw64"
          )
          foreach ($loc in $locations) {
            if (Test-Path $loc) {
              Write-Host "Checking $loc"
              if (Test-Path "$loc\include\freetype2") { Write-Host "  Found: $loc\include\freetype2" }
              if (Test-Path "$loc\lib\libfreetype.a") { Write-Host "  Found: $loc\lib\libfreetype.a" }
              if (Test-Path "$loc\lib\libfreetype.dll.a") { Write-Host "  Found: $loc\lib\libfreetype.dll.a" }
              if (Test-Path "$loc\lib\pkgconfig\freetype2.pc") { Write-Host "  Found: $loc\lib\pkgconfig\freetype2.pc" }
              if (Test-Path "$loc\bin\libfreetype-6.dll") { Write-Host "  Found: $loc\bin\libfreetype-6.dll" }
            }
          }
          Write-Host "PKG_CONFIG_PATH = $env:PKG_CONFIG_PATH"
          Write-Host "CMAKE_PREFIX_PATH = $env:CMAKE_PREFIX_PATH"

      - name: Configure (Windows - MSYS2 Mingw + Ninja)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          # Determine MSYS2 mingw64 path
          if (Test-Path 'C:\tools\msys64\mingw64') {
            $mingwPath = 'C:\tools\msys64\mingw64'
          } else {
            $mingwPath = 'C:\msys64\mingw64'
          }
          # Modify configure.bat to use the build_type from matrix and standardize build directory to 'build'
          (Get-Content configure.bat) `
            -replace '-DCMAKE_BUILD_TYPE=Release', "-DCMAKE_BUILD_TYPE=${{ matrix.build_type }}" `
            -replace 'build-win', 'build' | Set-Content configure_ci.bat
          # Append FreeType CMake hints to help find the library
          Add-Content configure_ci.bat "`t-DFREETYPE_INCLUDE_DIR_freetype2=`"$mingwPath/include/freetype2`" ^"
          Add-Content configure_ci.bat "`t-DFREETYPE_INCLUDE_DIR_ft2build=`"$mingwPath/include/freetype2`" ^"
          Add-Content configure_ci.bat "`t-DFREETYPE_LIBRARY=`"$mingwPath/lib/libfreetype.a`""
          # Run the configure script
          cmd /c configure_ci.bat

      - name: Build
        run: |
          cmake --build build --config ${{ matrix.build_type }} --parallel
        shell: bash

      - name: Run tests (if tests configured)
        run: |
          # If CTest tests are available, run them. Don't fail the whole job on test failures here unless desired.
          if [ -d build ]; then
            cmake --build build --target test --config ${{ matrix.build_type }} || true
          fi
        shell: bash
        if: matrix.os == 'ubuntu-latest'

      - name: Collect binary path candidates
        id: collect
        run: |
          # CMakeLists sets RUNTIME_OUTPUT_DIRECTORY ../ so executables may be in repository root or build dirs.
          candidates=()
          if [ -f fxed ]; then candidates+=("fxed"); fi
          if [ -f fxed.exe ]; then candidates+=("fxed.exe"); fi
          if [ -f build/fxed ]; then candidates+=("build/fxed"); fi
          if [ -f build/fxed.exe ]; then candidates+=("build/fxed.exe"); fi
          if [ -f build/${{ matrix.build_type }}/fxed.exe ]; then candidates+=("build/${{ matrix.build_type }}/fxed.exe"); fi
          if [ -f build/${{ matrix.build_type }}/fxed ]; then candidates+=("build/${{ matrix.build_type }}/fxed"); fi
          # Print found candidates (for logs) and join with newline for upload step
          for f in "${candidates[@]}"; do echo "FOUND_BINARY:$f"; done
          printf "%s\n" "${candidates[@]}" > artifact-list.txt || echo "No binaries found"
        shell: bash

      - name: Upload artifact (built executable)
        uses: actions/upload-artifact@v4
        with:
          name: fxed-binaries-${{ matrix.os }}-${{ matrix.build_type }}
          # Provide multiple candidate paths (artifact-list.txt plus common binary locations).
          path: |
            artifact-list.txt
            fxed
            fxed.exe
            build/fxed
            build/fxed.exe
            build/${{ matrix.build_type }}/fxed
            build/${{ matrix.build_type }}/fxed.exe
        # Note: upload-artifact will only include files that actually exist.

      - name: Print environment (debug)
        if: always()
        run: |
          echo "OS=${{ matrix.os }}"
          echo "BUILD_TYPE=${{ matrix.build_type }}"
          echo "VULKAN_SDK=${VULKAN_SDK}"
          uname -a || systeminfo
        shell: bash
